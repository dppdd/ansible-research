# Description  

We deploy the following services with these Ansible roles:
- Prometheus server
- Grafana
- Node Exporter
- cAdvisor

The master node is named `observer` as well as the respective Ansible role and inventory hosts. The monitored nodes are called `targets`. The stack runs on Docker containers. The cAdvisor service is used for monitoring the actual dockers.

## Requirements  
Nodes - CentOS 9 stream
Local - Python3.9+, Ansible 2.14+


## Project Architecture  
```.
├── group_vars
│   └── all
│       └── ports.yml        # All ports are defined here.
├── inventory                # Define the IPs/hostnames here. Or configure for dynamic lists.
├── playbook-observer.yml
├── playbook-targets.yml
├── readme.md
├── roles
│   ├── docker-env           # A role responsible for Docker installation and env requirements.
│   ├── observer             # Observer.
│   │   ├── files
│   │   │   └── grafana      #  Grafana  configs and dashboards 
│   │   │       ├── dashboards
│   │   │       │   └── main
│   │   │       │       ├── cadvisor.json
│   │   │       │       └── node-exporter.json
│   │   │       └── provisioning
│   │   │           ├── dashboards
│   │   │           │   └── all.yml
│   │   │           └── datasources       # We place the all.yml file generated by the datasources_all_yml.j2 
│   │   ├── tasks
│   │   │   ├── configs.yml  # Sub role for creating the required directories and copying the files/templates.
│   │   │   ├── dockers.yml  # Sub role for creating the docker containers of the Observer node.
│   │   │   └── main.yml
│   │   ├── templates
│   │   │   ├── datasources_all_yml.j2   # Template of Grafana datasources all.yml
│   │   │   └── prometheus_main.j2       # Template of prometheus.yml
│   │   └── vars
│   └── target              # Deploying the target(slave) servers dockers. Also used by the Observer 
│       ├── tasks
│       ├── templates
│       └── vars
└── site.yml
```
## How to run  
* First add your hostnames or IPs into the `inventory` file. The file is also responsible for SSH port, etc. Remove the unused directives.  
* Execute Ansible
`ansible-playbook -i inventory site.yml`
* Access Grafana at
`http://$observer_hostname:3000`

## Recommended post-configuration steps.  
Confirm that everything works, then:
- Secure Grafana - user, pass, SSL
- Allow node-exporter and cAdviser ports only for the Observer node.
- Check docker Linux user, confirm wheel privileges and start dockers with that user.
## TODOs
- Adding IP to the prometheus.yml does not affect the docker mount:
https://github.com/moby/moby/issues/15793
https://medium.com/@jonsbun/why-need-to-be-careful-when-mounting-single-files-into-a-docker-container-4f929340834
- Prometheus can reload its configuration at runtime, create handler for that:
curl -X POST $observer:9090/-/reload